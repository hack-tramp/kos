name: Compile Object Files for KolibriOS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  compile:
    runs-on: ubuntu-latest  # Use Ubuntu-based GitHub runner

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up MinGW (for compiling 32-bit)
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64

    - name: Compile mbedTLS
      run: |
        mkdir build
        cd build
        # Compile all mbedTLS source files into mbedtls.obj
        gcc -m32 -c ../library/*.c -O2 -Wall -I../include/mbedtls -o mbedtls.obj

    - name: Compile kosnet files
      run: |
        # Compile the kosnet networking files
        gcc -m32 -c ../kosnet/network.c -O2 -Wall -I../include/mbedtls -o network.o
        gcc -m32 -c ../kosnet/socket.c -O2 -Wall -I../include/mbedtls -o socket.o
        gcc -m32 -c ../kosnet/dlfcn.c -O2 -Wall -I../include/mbedtls -o dlfcn.o

    - name: Prepare files for USB (upload mbedtls.obj, mbedtls.inc, example.asm)
      run: |
        mkdir -p usb_files
        cp build/mbedtls.obj usb_files/
        cp ../include/mbedtls/mbedtls.inc usb_files/
        cp ../programs/example.asm usb_files/

    - name: Upload compiled files for USB
      uses: actions/upload-artifact@v2
      with:
        name: compiled-files
        path: usb_files/
