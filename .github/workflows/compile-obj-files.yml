name: Compile Object Files for KolibriOS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up MinGW (for compiling 32-bit)
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 gcc-multilib libc6-dev-i386

        
    - name: Compile mbedTLS + kosnet into single .obj
      run: |
        mkdir -p build
        # Compile mbedTLS
        gcc -m32 -c library/*.c -O2 -Wall -Iinclude -I. -o build/mbedtls_base.o
        # Compile kosnet files
        gcc -m32 -c kosnet/network.c -O2 -Wall -Iinclude -I. -o build/network.o
        gcc -m32 -c kosnet/socket.c -O2 -Wall -Iinclude -I. -o build/socket.o
        gcc -m32 -c kosnet/dlfcn.c -O2 -Wall -Iinclude -I. -o build/dlfcn.o
        # Merge all .o files into single KolibriOS .obj
        ld -m elf_i386 -r build/mbedtls_base.o build/network.o build/socket.o build/dlfcn.o -o build/mbedtls.obj

        

    - name: Prepare files for USB (upload mbedtls.obj, mbedtls.inc, example.asm)
      run: |
        mkdir -p usb_files
        cp build/mbedtls.obj usb_files/
        cp mbedtls.inc usb_files/ 
        cp example.asm usb_files/ 

    - name: Upload compiled files for USB
      uses: actions/upload-artifact@v4
      with:
        name: compiled-files
        path: usb_files/
