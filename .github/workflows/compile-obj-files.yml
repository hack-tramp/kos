name: Compile Object Files for KolibriOS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up MinGW (for compiling 32-bit)
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64

    - name: Compile mbedTLS
      run: |
        mkdir -p build
        gcc -m32 -c library/*.c -O2 -Wall -Iinclude/mbedtls
        # Combine all object files into a single .obj file if needed
        ld -r *.o -o build/mbedtls.obj

    - name: Compile kosnet files
      run: |
        gcc -m32 -c kosnet/network.c -O2 -Wall -Iinclude/mbedtls -o build/network.o
        gcc -m32 -c kosnet/socket.c -O2 -Wall -Iinclude/mbedtls -o build/socket.o
        gcc -m32 -c kosnet/dlfcn.c -O2 -Wall -Iinclude/mbedtls -o build/dlfcn.o

    - name: Prepare files for USB (upload mbedtls.obj, mbedtls.inc, example.asm)
      run: |
        mkdir -p usb_files
        cp build/mbedtls.obj usb_files/
        cp include/mbedtls/mbedtls.inc usb_files/ 
        cp programs/example.asm usb_files/ 

    - name: Upload compiled files for USB
      uses: actions/upload-artifact@v4
      with:
        name: compiled-files
        path: usb_files/
